<template>
  <header
    id="header"
    class="header-effect-shrink header-spacing"
    data-plugin-options='{"stickyEnabled": true}'
  >
    <!-- <header
    id="header"
    class="header-effect-shrink"
    data-plugin-options="{'stickyEnabled': true, 'stickyEffect': 'shrink', 'stickyEnableOnBoxed': true, 'stickyEnableOnMobile': false, 'stickyChangeLogo': true, 'stickyStartAt': 30, 'stickyHeaderContainerHeight': 70}"
    style="height: 103.2px"
  > -->
    <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
    <div v-if="isLoggedIn" class="header-body border-0">
      <div class="header-container container">
        <div class="header-row">
          <div class="header-left d-flex align-items-center order-0 order-lg-0">
            <router-link
              to="/"
              class="text-primary fs-3 text-decoration-none home"
            >
              Freelancer<br />
              Service
            </router-link>
          </div>
          <div
            class="header-nav header-nav-line header-nav-top-line header-nav-top-line-with-border order-2 order-lg-1"
          >
            <div
              class="header-nav-main header-nav-main-square header-nav-main-effect-2 header-nav-main-sub-effect-1"
            >
              <nav class="collapse">
                <ul class="nav nav-pills" id="mainNav">
                  <li class="dropdown">
                    <router-link
                      class="dropdown-item dropdown-toggle"
                      :class="{
                        active: isAffiliationActive,
                        'current-page-active': true,
                      }"
                      to="/affiliation"
                    >
                      ì†Œì†
                      <i class="fas fa-chevron-down"></i
                    ></router-link>
                  </li>
                  <li class="dropdown">
                    <router-link
                      class="dropdown-item dropdown-toggle"
                      :class="{
                        active: isProjectActive,
                        'current-page-active': true,
                      }"
                      to="/projectListPage"
                    >
                      í”„ë¡œì íŠ¸
                      <i class="fas fa-chevron-down"></i
                    ></router-link>
                  </li>
                  <li class="dropdown">
                    <router-link
                      class="dropdown-item dropdown-toggle"
                      :class="{
                        active: isCommunityActive,
                        'current-page-active': true,
                      }"
                      to="/board"
                    >
                      ì»¤ë®¤ë‹ˆí‹°
                      <i class="fas fa-chevron-down"></i
                    ></router-link>
                    <ul class="dropdown-menu">
                      <li>
                        <router-link class="dropdown-item" to="/board"
                          >ì¼ë°˜ ê²Œì‹œíŒ
                        </router-link>
                      </li>
                      <li>
                        <router-link class="dropdown-item" to="/qna"
                          >Q&A ê²Œì‹œíŒ
                        </router-link>
                      </li>
                    </ul>
                  </li>
                </ul>
              </nav>
            </div>
            <button
              class="btn header-btn-collapse-nav"
              data-bs-toggle="collapse"
              data-bs-target=".header-nav-main nav"
            >
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <div
            class="header-nav-features header-nav-features-no-border header-nav-features-lg-show-border order-1 order-lg-2"
          >
            <div
              class="header-nav-feature d-inline-flex gap-2 align-items-center"
            >
              <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
              <div class="dropdown">
                <a
                  href="#"
                  role="button"
                  class="btn btn-light d-flex justify-content-center align-items-center position-relative dropdown-toggle no-caret"
                  id="notificationDropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  style="width: 36px; height: 36px; border-radius: 50%"
                >
                  <i class="bi bi-bell fs-5"></i>

                  <!-- ì•Œë¦¼ ë°°ì§€ -->
                  <span
                    class="position-absolute border border-light rounded-circle"
                    style="
                      top: -1px;
                      right: -1px;
                      width: 10px;
                      height: 10px;
                      background-color: var(--bs-primary);
                      opacity: 0.85;
                    "
                  >
                  </span>
                </a>

                <!-- <div
                  class="dropdown-menu dropdown-menu-end p-2 shadow"
                  aria-labelledby="notificationDropdown"
                  style="min-width: 250px; max-height: 300px; overflow-y: auto"
                >
                  <h6 class="dropdown-header">ì•Œë¦¼</h6>
                  <div class="dropdown-item small text-muted">
                    ğŸ“Œ ìƒˆë¡œìš´ ëŒ“ê¸€ì´ ë‹¬ë ¸ì–´ìš” <br /><small>2ë¶„ ì „</small>
                  </div>
                  <div class="dropdown-item small text-muted">
                    âœ… í”„ë¡œì íŠ¸ê°€ ìŠ¹ì¸ë˜ì—ˆì–´ìš” <br /><small>10ë¶„ ì „</small>
                  </div>
                  <div class="dropdown-item small text-muted">
                    ğŸ”” ì‹œìŠ¤í…œ ì ê²€ ì˜ˆì • <br /><small>1ì‹œê°„ ì „</small>
                  </div>
                  <div class="dropdown-divider"></div>
                  <a
                    class="dropdown-item text-center small text-primary"
                    href="/notifications"
                    >ì „ì²´ ë³´ê¸°</a
                  >
                </div> -->
                <div
                  class="dropdown-menu dropdown-menu-end p-2 shadow"
                  aria-labelledby="notificationDropdown"
                  style="min-width: 250px"
                >
                  <div class="dropdown-item small text-muted">
                    ğŸ”§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.
                  </div>
                </div>
              </div>

              <!-- ìœ ì € ì•„ì´ì½˜ + ì´ë¦„ (ë²„íŠ¼ ì •ë ¬) -->
              <!-- ìœ ì € ì•„ì´ì½˜ + ì´ë¦„ (ë“œë¡­ë‹¤ìš´) -->
              <div class="dropdown">
                <a
                  href="#"
                  role="button"
                  class="btn btn-light d-flex align-items-center gap-2 px-3 py-1 dropdown-toggle"
                  style="height: 36px; border-radius: 50px"
                  id="userDropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="bi bi-person-circle fs-5"></i>
                  <span>{{ userStore.userNm }}</span>
                </a>

                <ul
                  class="dropdown-menu dropdown-menu-end mt-2"
                  aria-labelledby="userDropdown"
                  style="min-width: 150px"
                >
                  <li>
                    <router-link class="dropdown-item" to="/mypage"
                      >ë§ˆì´í˜ì´ì§€</router-link
                    >
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" @click.prevent="logout"
                      >ë¡œê·¸ì•„ì›ƒ</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
    <div v-else class="header-body border-0">
      <div class="header-container container">
        <div class="header-row">
          <div class="header-left d-flex align-items-center order-0 order-lg-0">
            <router-link
              to="/"
              class="text-primary fs-3 text-decoration-none home"
            >
              Freelancer<br />
              Service
            </router-link>
          </div>

          <!-- ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
          <div
            class="header-nav header-nav-line header-nav-top-line header-nav-top-line-with-border order-2 order-lg-1"
          >
            <div
              class="header-nav-main header-nav-main-square header-nav-main-effect-2 header-nav-main-sub-effect-1"
            >
              <nav class="collapse">
                <ul class="nav nav-pills" id="mainNav">
                  <li class="dropdown">
                    <router-link
                      class="dropdown-item dropdown-toggle"
                      :class="{
                        active: isAffiliationActive,
                        'current-page-active': true,
                      }"
                      to="/affiliation"
                    >
                      ì†Œì†
                      <i class="fas fa-chevron-down"></i>
                    </router-link>
                  </li>
                  <li class="dropdown">
                    <router-link
                      class="dropdown-item dropdown-toggle"
                      :class="{
                        active: isProjectActive,
                        'current-page-active': true,
                      }"
                      to="/projectListPage"
                    >
                      í”„ë¡œì íŠ¸
                      <i class="fas fa-chevron-down"></i>
                    </router-link>
                  </li>
                  <li class="dropdown">
                    <router-link
                      class="dropdown-item dropdown-toggle"
                      :class="{
                        active: isCommunityActive,
                        'current-page-active': true,
                      }"
                      to="/board"
                    >
                      ì»¤ë®¤ë‹ˆí‹°
                      <i class="fas fa-chevron-down"></i>
                    </router-link>
                    <ul class="dropdown-menu">
                      <li>
                        <router-link class="dropdown-item" to="/board"
                          >ì¼ë°˜ ê²Œì‹œíŒ</router-link
                        >
                      </li>
                      <li>
                        <router-link class="dropdown-item" to="/qna"
                          >Q&A ê²Œì‹œíŒ</router-link
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </nav>
            </div>
            <button
              class="btn header-btn-collapse-nav"
              data-bs-toggle="collapse"
              data-bs-target=".header-nav-main nav"
            >
              <i class="fas fa-bars"></i>
            </button>
          </div>

          <!-- ë¡œê·¸ì¸ ë§í¬ -->
          <div
            class="header-nav-features header-nav-features-no-border header-nav-features-lg-show-border order-1 order-lg-2"
          >
            <div class="header-nav-feature d-inline-flex">
              <router-link to="/login" class="text-muted text-decoration-none"
                >ë¡œê·¸ì¸</router-link
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
</template>

<script setup>
import { onMounted, onBeforeUnmount, computed } from 'vue'
import { useUserStore } from '@/fo/stores/userStore'
import { useAlertStore } from '@/fo/stores/alertStore'
import router from '@/fo/router'
import { api } from '@/axios'
import { useRoute } from 'vue-router'

const alertStore = useAlertStore()
const userStore = useUserStore()
const isLoggedIn = computed(() => userStore.isLoggedIn)
const route = useRoute()

// í˜„ì¬ ê²½ë¡œ
const currentPath = computed(() => route.path)

// ê° ë©”ë‰´ì˜ í™œì„± ì—¬ë¶€ íŒë³„
const isAffiliationActive = computed(() =>
  currentPath.value.startsWith('/affiliation'),
)
const isProjectActive = computed(() =>
  currentPath.value.startsWith('/projectListPage'),
)
const isCommunityActive = computed(() =>
  ['/board', '/qna'].some((path) => currentPath.value.startsWith(path)),
)

const logout = async () => {
  await api.$post('/logout', {}) // ì„œë²„ ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ

  // 1. ì•„ì´ë”” ì €ì¥ê°’(ê°œì¸/ê¸°ì—… ì•„ì´ë””, ë¡œê·¸ì¸ íƒ€ì…)ë§Œ ë”°ë¡œ ì €ì¥í•´ë‘ 
  const savedPersonalId = localStorage.getItem('savedPersonalId')
  const savedCompanyId = localStorage.getItem('savedCompanyId')
  const savedLoginType = localStorage.getItem('savedLoginType')

  // 2. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì „ì²´ ì´ˆê¸°í™”
  localStorage.clear()

  // 3. ì•„ì´ë”” ì €ì¥ê°’ ë³µì›
  if (savedPersonalId) localStorage.setItem('savedPersonalId', savedPersonalId)
  if (savedCompanyId) localStorage.setItem('savedCompanyId', savedCompanyId)
  if (savedLoginType) localStorage.setItem('savedLoginType', savedLoginType)

  // 4. Pinia ìƒíƒœ ì´ˆê¸°í™”
  userStore.$reset() // userStoreê°€ Pinia storeë¼ë©´ $reset() ìœ¼ë¡œ ì´ˆê¸°í™” ê°€
  alertStore.show('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
  // 5. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
  router.push('/')
}

const handleScroll = () => {
  const header = document.querySelector('.header-body')
  if (window.scrollY > 50) {
    header.classList.add('shrink')
  } else {
    header.classList.remove('shrink')
  }
}

onMounted(() => {
  window.addEventListener('scroll', handleScroll)
  console.log('currentPath', currentPath.value)
})

onBeforeUnmount(() => {
  window.removeEventListener('scroll', handleScroll)
})
</script>

<style scoped>
.home {
  font-weight: bold;
  display: block;
  text-align: center;
}

.header-body {
  position: fixed !important;
  top: 0;
  z-index: 999;
  width: 100%;
  background: white;
  height: 100px; /* ì´ˆê¸° ë†’ì´ ì„¤ì • */
  transition:
    height 0.3s ease,
    box-shadow 0.3s ease; /* transitionì„ heightì™€ box-shadowì—ë§Œ ì ìš© */
}

.header-body.shrink {
  height: 70px; /* ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” í¬ê¸° ì¤„ì–´ë“¬ */
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ìŠ¤í¬ë¡¤ ì‹œ ê·¸ë¦¼ì íš¨ê³¼ */
}

/* dropdown-toggle í´ë˜ìŠ¤ì˜ í™”ì‚´í‘œ ì œê±° */
#notificationDropdown::after {
  display: none !important;
}
</style>
